const STATE = require('STATE')
const statedb = STATE(__filename)
const { sdb, get } = statedb(fallback_module)

const console_history = require('console_history')
const actions = require('actions')

module.exports = component

async function component (opts, protocol) {
  const { id, sdb } = await get(opts.sid)
  const on = {
    style: inject_style
  }

  const el = document.createElement('div')
  const shadow = el.attachShadow({ mode: 'closed' })
  shadow.innerHTML = `
  <div class="space">
    <actions-placeholder></actions-placeholder>
    <console-history-placeholder></console-history-placeholder>
  </div>`

  const actions_placeholder = shadow.querySelector('actions-placeholder')
  const console_placeholder = shadow.querySelector('console-history-placeholder')
  let console_history_el = null
  let actions_el = null

  const subs = await sdb.watch(onbatch)
  let send = null
  let _ = null
  if(protocol) {
    send = protocol(msg => onmessage(msg))
    _ = { up: send, actions: null, console_history: null }
  }
  const api = { toggle_console_history, show_actions, hide_actions, toggle_actions, filter_actions }
  
  actions_el = protocol ? await actions(subs[1], actions_protocol) : await actions(subs[1])
  actions_el.classList.add('actions')
  actions_placeholder.replaceWith(actions_el)
  
  console_history_el = protocol ? await console_history(subs[0], console_history_protocol) : await console_history(subs[0])
  console_history_el.classList.add('console-history')
  console_placeholder.replaceWith(console_history_el)
  return el

  // ---------
  // PROTOCOLS
  // ---------
  function console_history_protocol (send) {
    _.send_console_history = send
    return on
    function on ({ type, data }) { 
      console.log('[console_history->space]', type, data)
      if (type === 'toggle') {
        _.up({ type: 'toggle_console_history', data })
      }
    }
  }
  
  function actions_protocol (send) {
    _.send_actions = send
    return on
    function on ({ type, data }) { 
      console.log('[actions->space]', type, data)
      if (type === 'action_selected') {
        _.up({ type: 'actions:action_selected', data })
      }
      if (type.startsWith('quick_actions_callback:')) {
        _.up({ type, data })
      }
    }
  }
  
  function onmessage ({ type, data }) {
    console.log(`[theme_widget->space]`, type, data)
    const fn = api[type]
    if (fn) return fn({ type, data })
    
    // Route actions messages to actions component
    if (type.startsWith('actions:')) {
      const action_type = type.replace('actions:', '')
      _.send_actions({ type: action_type, data })
    }
    
    // Route quick_actions messages to actions component (for set_selected_action)
    if (type.startsWith('quick_actions:')) {
      const action_type = type.replace('quick_actions:', '')
      _.send_actions({ type: action_type, data })
    }
    
    throw new Error('invalid msg', { cause: { type, data } })
  }
  
  // ---
  // API
  // ---
  function toggle_console_history (msg) { 
    if (_.console_history) _.send_console_history({ type: 'toggle', data: msg.data }) 
  }
  function show_actions (msg) { 
    if (_.actions) _.send_actions({ type: 'show', data: msg.data }) 
  }
  function hide_actions (msg) { 
    if (_.actions) _.send_actions({ type: 'hide', data: msg.data }) 
  }
  function toggle_actions (msg) { 
    if (_.actions) _.send_actions({ type: 'toggle', data: msg.data }) 
  }
  function filter_actions (msg) { 
    if (_.actions) _.send_actions({ type: 'filter', data: msg.data }) 
  }

  function onbatch (batch) {
    for (const { type, data } of batch) {
      on[type] && on[type](data)
    }
  }

  function inject_style (data) {
    const sheet = new CSSStyleSheet()
    sheet.replaceSync(data)
    shadow.adoptedStyleSheets = [sheet]
  }
}

function fallback_module () {
  return {
    api: fallback_instance,
    _: {
      'console_history': {
        $: ''
      },
      'actions': {
        $: ''
      }
    }
  }

  function fallback_instance () {
    return {
      _: {
        'console_history': {
          0: '',
          mapping: {
            'style': 'style',
            'commands': 'commands',
            'icons': 'icons',
            'scroll': 'scroll'
          }
        },
        'actions': {
          0: '',
          mapping: {
            'style': 'style',
            'actions': 'actions',
            'icons': 'icons',
            'hardcons': 'hardcons'
          }
        }
      },
      drive: {
        'style/': {
          'theme.css': {
            raw: `
              .space {
                display: flex;
                min-height: 100px;
                width: 100%;
                height: inherit;
                flex-direction: column-reverse;
                background-color:#2e3440;
                position: relative;
              }
              .console-history {
                position: relative;
                width: 100%;
              }
              .actions {
                position: relative;
                width: 100%;
              }
            `
          }
        }
      }
    }
  }
}
